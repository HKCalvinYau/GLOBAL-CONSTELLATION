---
// Keystatic 後台路由
import { makePage } from '@keystatic/astro/ui';
import keystaticConfig from '../../../keystatic.config';

export const prerender = false;

// 在 Cloudflare Pages 中，環境變數通過 context.env 訪問
// 但 Astro 使用 import.meta.env，需要通過 Astro.locals 或直接訪問
// 嘗試多種方式訪問環境變數
let owner, repo, token;

// 方法 1: import.meta.env (標準方式)
owner = import.meta.env.KEYSTATIC_GITHUB_OWNER;
repo = import.meta.env.KEYSTATIC_GITHUB_REPO;
token = import.meta.env.KEYSTATIC_GITHUB_TOKEN;

// 方法 2: 通過 Astro.locals (Cloudflare 特定)
if (!owner && Astro.locals.runtime) {
  const runtime = Astro.locals.runtime as any;
  if (runtime.env) {
    owner = owner || runtime.env.KEYSTATIC_GITHUB_OWNER;
    repo = repo || runtime.env.KEYSTATIC_GITHUB_REPO;
    token = token || runtime.env.KEYSTATIC_GITHUB_TOKEN;
  }
}

// 方法 3: 通過 context (如果可用)
if (!owner && (Astro as any).context) {
  const context = (Astro as any).context;
  if (context.env) {
    owner = owner || context.env.KEYSTATIC_GITHUB_OWNER;
    repo = repo || context.env.KEYSTATIC_GITHUB_REPO;
    token = token || context.env.KEYSTATIC_GITHUB_TOKEN;
  }
}

// 記錄環境變數狀態（用於調試）
console.log('Keystatic 環境變數檢查:', {
  owner: owner ? '已設置: ' + owner : '未設置',
  repo: repo ? '已設置: ' + repo : '未設置',
  token: token ? '已設置' : '未設置',
  'import.meta.env': {
    KEYSTATIC_GITHUB_OWNER: import.meta.env.KEYSTATIC_GITHUB_OWNER || 'undefined',
    KEYSTATIC_GITHUB_REPO: import.meta.env.KEYSTATIC_GITHUB_REPO || 'undefined',
    KEYSTATIC_GITHUB_TOKEN: import.meta.env.KEYSTATIC_GITHUB_TOKEN ? '已設置' : '未設置'
  },
  'Astro.locals.runtime': Astro.locals.runtime ? '存在' : '不存在'
});

// 如果缺少必要的環境變數，顯示錯誤訊息
if (!owner || !repo) {
  return new Response(
    `<!DOCTYPE html>
<html>
<head>
  <title>Keystatic 配置錯誤</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 600px; margin: 50px auto; padding: 20px; }
    .error { background: #fee; border: 1px solid #fcc; padding: 20px; border-radius: 8px; }
    .info { background: #eef; border: 1px solid #ccf; padding: 20px; border-radius: 8px; margin-top: 20px; }
    code { background: #f5f5f5; padding: 2px 6px; border-radius: 3px; }
  </style>
</head>
<body>
  <div class="error">
    <h1>⚠️ Keystatic 配置錯誤</h1>
    <p>缺少必要的環境變數：</p>
    <ul>
      ${!owner ? '<li><code>KEYSTATIC_GITHUB_OWNER</code> 未設置</li>' : ''}
      ${!repo ? '<li><code>KEYSTATIC_GITHUB_REPO</code> 未設置</li>' : ''}
    </ul>
  </div>
  <div class="info">
    <h2>如何修復：</h2>
    <ol>
      <li>登入 <a href="https://dash.cloudflare.com/">Cloudflare Dashboard</a></li>
      <li>進入 <strong>Pages</strong> → 選擇您的專案</li>
      <li>點擊 <strong>Settings</strong> → <strong>Environment variables</strong></li>
      <li>添加以下環境變數：
        <ul>
          <li><code>KEYSTATIC_GITHUB_OWNER</code> = <code>HKCalvinYau</code></li>
          <li><code>KEYSTATIC_GITHUB_REPO</code> = <code>GLOBAL-CONSTELLATION</code></li>
        </ul>
      </li>
      <li>選擇 <strong>All environments</strong>，然後點擊 <strong>Save</strong></li>
      <li>重新部署專案</li>
    </ol>
    <p><strong>當前狀態：</strong></p>
    <ul>
      <li>KEYSTATIC_GITHUB_OWNER: ${owner || '❌ 未設置'}</li>
      <li>KEYSTATIC_GITHUB_REPO: ${repo || '❌ 未設置'}</li>
      <li>KEYSTATIC_GITHUB_TOKEN: ${token ? '✅ 已設置' : '⚠️ 未設置（如果倉庫是公開的則不需要）'}</li>
    </ul>
  </div>
</body>
</html>`,
    {
      status: 200,
      headers: { 'Content-Type': 'text/html; charset=utf-8' }
    }
  );
}

try {
  console.log('開始初始化 Keystatic...');
  const KeystaticPage = makePage(keystaticConfig);
  console.log('Keystatic 頁面創建成功，開始處理請求...');
  
  const result = await KeystaticPage(Astro);
  console.log('Keystatic 處理完成，結果類型:', typeof result);
  console.log('Keystatic 結果:', result ? '有結果' : '無結果');
  
  if (!result) {
    throw new Error('Keystatic 返回了空結果');
  }
  
  // 確保返回的是有效的 Response 對象
  if (result instanceof Response) {
    console.log('返回 Response 對象，狀態碼:', result.status);
    return result;
  }
  
  // 如果不是 Response 對象，包裝它
  console.log('結果不是 Response 對象，進行包裝');
  return new Response(result, {
    status: 200,
    headers: {
      'Content-Type': 'text/html; charset=utf-8'
    }
  });
} catch (error) {
  console.error('Keystatic 錯誤:', error);
  console.error('錯誤堆棧:', error instanceof Error ? error.stack : '無堆棧信息');
  
  const errorMessage = error instanceof Error ? error.message : String(error);
  const errorStack = error instanceof Error ? error.stack : '無堆棧信息';
  
  const html = `<!DOCTYPE html>
<html>
<head>
  <title>Keystatic 錯誤</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
    .error { background: #fee; border: 1px solid #fcc; padding: 20px; border-radius: 8px; }
    .info { background: #eef; border: 1px solid #ccf; padding: 20px; border-radius: 8px; margin-top: 20px; }
    pre { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px; }
    code { background: #f5f5f5; padding: 2px 6px; border-radius: 3px; }
  </style>
</head>
<body>
  <div class="error">
    <h1>❌ Keystatic 運行錯誤</h1>
    <p>發生以下錯誤：</p>
    <pre>${errorMessage}</pre>
    <details style="margin-top: 20px;">
      <summary style="cursor: pointer; font-weight: bold;">查看詳細錯誤信息</summary>
      <pre style="margin-top: 10px;">${errorStack}</pre>
    </details>
  </div>
  <div class="info">
    <h2>可能的解決方法：</h2>
    <ol>
      <li>確認環境變數已正確設置：
        <ul>
          <li><code>KEYSTATIC_GITHUB_OWNER</code> = <code>HKCalvinYau</code></li>
          <li><code>KEYSTATIC_GITHUB_REPO</code> = <code>GLOBAL-CONSTELLATION</code></li>
          <li><code>KEYSTATIC_GITHUB_TOKEN</code>（如果倉庫是私有的）</li>
        </ul>
      </li>
      <li>確認環境變數應用於 <strong>All environments</strong></li>
      <li>檢查 Cloudflare Pages 的運行時日誌</li>
      <li>確認 GitHub Token 有正確的權限（<code>repo</code>）</li>
      <li>重新部署專案</li>
    </ol>
    <p><strong>當前環境變數狀態：</strong></p>
    <ul>
      <li>KEYSTATIC_GITHUB_OWNER: ${owner || '❌ 未設置'}</li>
      <li>KEYSTATIC_GITHUB_REPO: ${repo || '❌ 未設置'}</li>
      <li>KEYSTATIC_GITHUB_TOKEN: ${token ? '✅ 已設置' : '⚠️ 未設置'}</li>
    </ul>
  </div>
</body>
</html>`;
  
  return new Response(html, {
    status: 200,
    headers: { 'Content-Type': 'text/html; charset=utf-8' }
  });
}
---

