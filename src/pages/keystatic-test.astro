---
// æ¸¬è©¦é é¢ï¼šæª¢æŸ¥ç’°å¢ƒè®Šæ•¸å’Œ Keystatic é…ç½®
export const prerender = false;

// å˜—è©¦å¤šç¨®æ–¹å¼è¨ªå•ç’°å¢ƒè®Šæ•¸
let owner, repo, token;

// æ–¹æ³• 1: import.meta.env (æ¨™æº–æ–¹å¼)
owner = import.meta.env.KEYSTATIC_GITHUB_OWNER;
repo = import.meta.env.KEYSTATIC_GITHUB_REPO;
token = import.meta.env.KEYSTATIC_GITHUB_TOKEN;

// æ–¹æ³• 2: é€šé Astro.locals.runtime (Cloudflare ç‰¹å®š)
if (!owner && Astro.locals.runtime) {
  const runtime = Astro.locals.runtime as any;
  if (runtime.env) {
    owner = owner || runtime.env.KEYSTATIC_GITHUB_OWNER;
    repo = repo || runtime.env.KEYSTATIC_GITHUB_REPO;
    token = token || runtime.env.KEYSTATIC_GITHUB_TOKEN;
  }
}

// æ–¹æ³• 3: é€šé context (å¦‚æœå¯ç”¨)
if (!owner && (Astro as any).context) {
  const context = (Astro as any).context;
  if (context.env) {
    owner = owner || context.env.KEYSTATIC_GITHUB_OWNER;
    repo = repo || context.env.KEYSTATIC_GITHUB_REPO;
    token = token || context.env.KEYSTATIC_GITHUB_TOKEN;
  }
}

// è©³ç´°æ—¥èªŒè¨˜éŒ„
console.log('æ¸¬è©¦é é¢ - ç’°å¢ƒè®Šæ•¸æª¢æŸ¥:', {
  owner: owner ? 'å·²è¨­ç½®: ' + owner : 'æœªè¨­ç½®',
  repo: repo ? 'å·²è¨­ç½®: ' + repo : 'æœªè¨­ç½®',
  token: token ? 'å·²è¨­ç½®' : 'æœªè¨­ç½®',
  'import.meta.env': {
    KEYSTATIC_GITHUB_OWNER: import.meta.env.KEYSTATIC_GITHUB_OWNER || 'undefined',
    KEYSTATIC_GITHUB_REPO: import.meta.env.KEYSTATIC_GITHUB_REPO || 'undefined',
    KEYSTATIC_GITHUB_TOKEN: import.meta.env.KEYSTATIC_GITHUB_TOKEN ? 'å·²è¨­ç½®' : 'æœªè¨­ç½®'
  },
  'Astro.locals.runtime': Astro.locals.runtime ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨',
  'Astro.locals': Object.keys(Astro.locals).length > 0 ? 'æœ‰å…§å®¹' : 'ç©º'
});
---

<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Keystatic æ¸¬è©¦é é¢</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .success { border-left: 4px solid #10b981; }
    .error { border-left: 4px solid #ef4444; }
    .warning { border-left: 4px solid #f59e0b; }
    h1 { margin-top: 0; }
    code {
      background: #f5f5f5;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: monospace;
    }
    .status {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
    }
    .status.ok { background: #d1fae5; color: #065f46; }
    .status.missing { background: #fee2e2; color: #991b1b; }
  </style>
</head>
<body>
  <div class="card">
    <h1>ğŸ” Keystatic è¨ºæ–·æ¸¬è©¦</h1>
    <p>é€™å€‹é é¢ç”¨æ–¼æª¢æŸ¥ç’°å¢ƒè®Šæ•¸å’Œé…ç½®æ˜¯å¦æ­£ç¢ºã€‚</p>
  </div>

  <div class="card {owner && repo ? 'success' : 'error'}">
    <h2>ç’°å¢ƒè®Šæ•¸ç‹€æ…‹</h2>
    <ul style="list-style: none; padding: 0;">
      <li style="margin: 10px 0;">
        <code>KEYSTATIC_GITHUB_OWNER</code>:
        <span class="status {owner ? 'ok' : 'missing'}">
          {owner ? 'âœ… å·²è¨­ç½®: ' + owner : 'âŒ æœªè¨­ç½®'}
        </span>
      </li>
      <li style="margin: 10px 0;">
        <code>KEYSTATIC_GITHUB_REPO</code>:
        <span class="status {repo ? 'ok' : 'missing'}">
          {repo ? 'âœ… å·²è¨­ç½®: ' + repo : 'âŒ æœªè¨­ç½®'}
        </span>
      </li>
      <li style="margin: 10px 0;">
        <code>KEYSTATIC_GITHUB_TOKEN</code>:
        <span class="status {token ? 'ok' : 'missing'}">
          {token ? 'âœ… å·²è¨­ç½®' : 'âš ï¸ æœªè¨­ç½®ï¼ˆå¦‚æœå€‰åº«æ˜¯å…¬é–‹çš„å‰‡ä¸éœ€è¦ï¼‰'}
        </span>
      </li>
    </ul>
  </div>

  {owner && repo ? (
    <div class="card success">
      <h2>âœ… ç’°å¢ƒè®Šæ•¸é…ç½®æ­£ç¢º</h2>
      <p>å¦‚æœä»ç„¶ç„¡æ³•è¨ªå• <code>/keystatic</code>ï¼Œå¯èƒ½æ˜¯ Keystatic æœ¬èº«çš„å•é¡Œã€‚</p>
      <p>è«‹æŸ¥çœ‹é‹è¡Œæ™‚æ—¥èªŒä»¥ç²å–æ›´å¤šä¿¡æ¯ã€‚</p>
    </div>
  ) : (
    <div class="card error">
      <h2>âŒ ç’°å¢ƒè®Šæ•¸æœªè¨­ç½®</h2>
      <p>è«‹åœ¨ Cloudflare Pages è¨­ç½®ä¸­æ·»åŠ ç’°å¢ƒè®Šæ•¸ï¼š</p>
      <ol>
        <li>é€²å…¥ <strong>Settings</strong> â†’ <strong>Environment variables</strong></li>
        <li>æ·»åŠ  <code>KEYSTATIC_GITHUB_OWNER</code> = <code>HKCalvinYau</code></li>
        <li>æ·»åŠ  <code>KEYSTATIC_GITHUB_REPO</code> = <code>GLOBAL-CONSTELLATION</code></li>
        <li>é¸æ“‡ <strong>All environments</strong></li>
        <li>é‡æ–°éƒ¨ç½²</li>
      </ol>
    </div>
  )}

  <div class="card warning">
    <h2>ğŸ“ ä¸‹ä¸€æ­¥</h2>
    <ol>
      <li>è¨ªå• <a href="/keystatic">/keystatic</a> æŸ¥çœ‹æ˜¯å¦æ­£å¸¸å·¥ä½œ</li>
      <li>æŸ¥çœ‹ Cloudflare Pages çš„ <strong>Real-time Logs</strong></li>
      <li>æª¢æŸ¥æ˜¯å¦æœ‰éŒ¯èª¤è¨Šæ¯</li>
    </ol>
  </div>
</body>
</html>

