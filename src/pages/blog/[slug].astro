---
import Layout from '../../layouts/Layout.astro';

// 在 Cloudflare Pages 環境中，使用條件導入
let reader;
try {
  const { createReader } = await import('@keystatic/core/reader');
  const keystaticConfig = (await import('../../../keystatic.config')).default;
  const repoPath = import.meta.env.KEYSTATIC_GITHUB_OWNER ? '.' : (import.meta.env.PWD || '.');
  reader = createReader(repoPath, keystaticConfig);
} catch (e) {
  console.warn('無法初始化 Keystatic reader:', e);
  reader = null;
}

export async function getStaticPaths() {
  if (!reader) {
    return [];
  }
  const posts = await reader.collections.posts.all();
  
  // 處理每篇文章的標籤和分類
  const processedPosts = await Promise.all(
    posts.map(async (post) => {
      // 讀取分類資訊
      let categoryData = null;
      if (post.entry.category) {
        try {
          categoryData = await reader.collections.categories.read(post.entry.category);
        } catch (e) {
          console.warn(`無法讀取分類: ${post.entry.category}`, e);
        }
      }

      // 讀取標籤資訊
      const tagsData = [];
      if (post.entry.tags && Array.isArray(post.entry.tags)) {
        for (const tagSlug of post.entry.tags) {
          try {
            const tagData = await reader.collections.tags.read(tagSlug);
            if (tagData) {
              tagsData.push(tagData);
            }
          } catch (e) {
            console.warn(`無法讀取標籤: ${tagSlug}`, e);
          }
        }
      }

      return {
    params: { slug: post.slug },
        props: {
          post: {
            ...post,
            categoryData,
            tagsData,
          },
        },
      };
    })
  );
  
  return processedPosts;
}

interface Props {
  post: {
    slug: string;
    entry: {
      title: string;
      publishedDate: string;
      excerpt?: string;
      coverImage?: string;
      views?: number;
      content: any;
    };
    categoryData?: any;
    tagsData?: any[];
  };
}

const { post } = Astro.props;
// Keystatic document 欄位需要使用 render 方法
const content = await post.entry.content();
---

<Layout 
  title={`${post.entry.title} | AMAR`}
  description={post.entry.excerpt || post.entry.title}
  image={post.entry.coverImage || '/images/og-image.jpg'}
>
  <!-- Navbar -->
  <nav class="fixed w-full z-50 transition-all duration-300 bg-white/90 backdrop-blur-md shadow-md py-3">
    <div class="container mx-auto px-6 flex justify-between items-center">
      <div class="text-2xl font-serif font-bold text-indigo-900 tracking-wider flex items-center gap-2">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 002 2h2.945M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <a href="/">AMAR</a>
      </div>
      <div class="hidden md:flex items-center gap-8 font-medium text-slate-600">
        <a href="/#problem" class="hover:text-indigo-600 transition">生命卡點</a>
        <a href="/#method" class="hover:text-indigo-600 transition">系統原理</a>
        <a href="/#instructor" class="hover:text-indigo-600 transition">導師介紹</a>
        <a href="/blog" class="hover:text-indigo-600 transition">部落格</a>
        <a href="/#offer" class="bg-indigo-900 text-white px-6 py-2 rounded-full hover:bg-indigo-800 transition">
          立即報名
        </a>
      </div>
    </div>
  </nav>

  <!-- Article Header -->
  <header class="pt-24 pb-12 bg-gradient-to-br from-slate-50 via-indigo-50 to-slate-200">
    <div class="container mx-auto px-6 max-w-4xl">
      <a 
        href="/blog" 
        class="inline-flex items-center gap-2 text-indigo-600 hover:text-indigo-800 mb-6 transition"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
        返回部落格
      </a>
      
      <h1 class="text-4xl md:text-5xl font-serif font-bold text-slate-900 mb-4">
        {post.entry.title}
      </h1>
      
      <div class="flex flex-wrap items-center gap-4 text-slate-600 mb-4">
        <time>
          {new Date(post.entry.publishedDate).toLocaleDateString('zh-TW', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
          })}
        </time>
        <span class="flex items-center gap-1">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
          </svg>
          {post.entry.views || 0} 次閱讀
        </span>
      </div>
      
      {/* 分類和標籤 */}
      <div class="flex flex-wrap items-center gap-2 mb-4">
        {post.categoryData && (
          <span 
            class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-indigo-100 text-indigo-800"
            style={post.categoryData.entry.color ? `background-color: ${post.categoryData.entry.color}20; color: ${post.categoryData.entry.color};` : ''}
          >
            {post.categoryData.entry.displayName}
          </span>
        )}
        {post.tagsData && post.tagsData.length > 0 && (
          post.tagsData.map((tag: any) => (
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-slate-100 text-slate-700">
              #{tag.entry.displayName}
            </span>
          ))
        )}
      </div>
      
      {post.entry.excerpt && (
        <p class="text-xl text-slate-600 mt-4 leading-relaxed">
          {post.entry.excerpt}
        </p>
      )}
    </div>
  </header>

  <!-- Article Content -->
  <main class="container mx-auto px-6 py-12 max-w-4xl">
    {post.entry.coverImage && (
      <img 
        src={post.entry.coverImage} 
        alt={post.entry.title}
        class="w-full rounded-xl shadow-lg mb-8"
      />
    )}
    
    <article class="prose prose-lg prose-slate max-w-none">
      {content && (
        <div set:html={content} />
      )}
    </article>
  </main>

  <!-- Footer -->
  <footer class="bg-slate-950 text-slate-400 py-12 border-t border-slate-800 mt-12">
    <div class="container mx-auto px-6 text-center">
      <p class="text-sm">© 2024 AMAR. All rights reserved.</p>
    </div>
  </footer>

  <style>
    /* 文章內容樣式 */
    .prose {
      color: rgb(51 65 85);
    }
    .prose h2 {
      color: rgb(15 23 42);
      font-weight: 700;
      margin-top: 2em;
      margin-bottom: 1em;
    }
    .prose h3 {
      color: rgb(15 23 42);
      font-weight: 600;
      margin-top: 1.5em;
      margin-bottom: 0.75em;
    }
    .prose p {
      margin-top: 1.25em;
      margin-bottom: 1.25em;
      line-height: 1.75;
    }
    .prose a {
      color: rgb(79 70 229);
      text-decoration: underline;
    }
    .prose a:hover {
      color: rgb(67 56 202);
    }
    .prose img {
      border-radius: 0.5rem;
      margin-top: 2em;
      margin-bottom: 2em;
    }
    .prose ul, .prose ol {
      margin-top: 1.25em;
      margin-bottom: 1.25em;
      padding-left: 1.625em;
    }
    .prose li {
      margin-top: 0.5em;
      margin-bottom: 0.5em;
    }
    .prose blockquote {
      border-left: 4px solid rgb(79 70 229);
      padding-left: 1em;
      margin-top: 1.6em;
      margin-bottom: 1.6em;
      font-style: italic;
      color: rgb(100 116 139);
    }
  </style>
</Layout>

